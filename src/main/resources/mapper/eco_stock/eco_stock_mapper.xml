<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.phoenix.planet.mapper.EcoStockMapper">

    <select id="selectById" parameterType="long"
        resultType="org.phoenix.planet.dto.eco_stock.raw.EcoStock">
        SELECT
        eco_stock_id AS id,
        name,
        quantity,
        image_url AS imageUrl
        FROM eco_stock
        WHERE eco_stock_id = #{id}
    </select>


    <select id="findAll"
            resultType="org.phoenix.planet.dto.eco_stock.raw.EcoStock">
        SELECT
        es.eco_stock_id AS id,
        es.name AS name,
        es.quantity AS quantity,
        es.image_url AS imageUrl
        FROM eco_stock es
        ORDER BY es.eco_stock_id ASC
    </select>

    <update id="updateQuantityById">
        UPDATE ECO_STOCK
        SET QUANTITY = #{updateQuantity},
        UPDATED_AT = SYSDATE
        WHERE ECO_STOCK_ID = #{stockId}
    </update>

    
    <select id="findAllHistory"
            resultType="org.phoenix.planet.dto.eco_stock.raw.EcoStockUpdatePriceRecord">
        WITH basic_info AS (
            SELECT
                es.eco_stock_id,
                COUNT(si.stock_issue_id) AS stock_issue_count,
                es.quantity,
                es.init_price
            FROM eco_stock es
            LEFT JOIN stock_issue si ON es.eco_stock_id = si.eco_stock_id
            AND si.created_at >= #{targetTime}
            GROUP BY es.eco_stock_id, es.quantity, es.init_price
        ),
        transaction_counts AS (
            SELECT
                sph.eco_stock_id,
                SUM(th.sell_count) AS transaction_count
            FROM stock_price_history sph
            JOIN transaction_history th ON sph.stock_price_history_id = th.stock_price_history_id
            AND sph.stock_time = #{targetTime}
            AND th.created_at >= #{targetTime}
            GROUP BY sph.eco_stock_id
        ),
        raffle_counts AS (
            SELECT
                r.ECO_STOCK_ID,
                SUM(r.ECO_STOCK_AMOUNT) AS raffle_count
            FROM RAFFLE_HISTORY rh
            JOIN RAFFLE r ON r.RAFFLE_ID = rh.RAFFLE_ID
            AND rh.created_at >= #{targetTime}
            GROUP BY r.ECO_STOCK_ID
        ),
        latest_prices AS (
            SELECT
                eco_stock_id,
                stock_price
            FROM (
                SELECT
                    eco_stock_id,
                    stock_price,
                    ROW_NUMBER() OVER (PARTITION BY eco_stock_id ORDER BY stock_time DESC) AS rn
                FROM stock_price_history
                WHERE #{targetTime} >= stock_time
            ) ranked
            WHERE rn = 1
        )
        SELECT
            bi.eco_stock_id AS ecoStockId,
            bi.stock_issue_count AS stockIssueCount,
            COALESCE(tc.transaction_count, 0) AS transactionHistoryCount,
            COALESCE(rc.raffle_count, 0) AS raffleHistoryCount,
            COALESCE(lp.stock_price, bi.init_price) AS beforePrice,
            bi.quantity,
            bi.init_price AS initPrice
        FROM basic_info bi
        LEFT JOIN transaction_counts tc ON bi.eco_stock_id = tc.eco_stock_id
        LEFT JOIN raffle_counts rc ON bi.eco_stock_id = rc.ECO_STOCK_ID
        LEFT JOIN latest_prices lp ON bi.eco_stock_id = lp.eco_stock_id
        ORDER BY bi.eco_stock_id
    </select>

    <update id="callSellStockProcedure" statementType="CALLABLE">
        {call SELL_STOCK_TRANSACTION(
        #{memberId, mode=IN, jdbcType=NUMERIC},
        #{request.ecoStockId, mode=IN, jdbcType=NUMERIC},
        #{request.sellCount, mode=IN, jdbcType=NUMERIC},
        #{request.sellPrice, mode=IN, jdbcType=NUMERIC},
        #{request.pSuccess, mode=OUT, jdbcType=NUMERIC, javaType=Integer},
        #{request.pMessage, mode=OUT, jdbcType=VARCHAR}
        )}
    </update>
</mapper>