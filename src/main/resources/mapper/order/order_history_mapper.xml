<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.phoenix.planet.mapper.OrderHistoryMapper">
    
    <!-- 주문 내역 저장 -->
    <insert id="insert" parameterType="org.phoenix.planet.dto.order.raw.OrderHistory"
        useGeneratedKeys="true" keyProperty="orderHistoryId">
        <selectKey keyProperty="orderHistoryId" resultType="long" order="BEFORE">
            SELECT SEQ_ORDER_HISTORY.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO order_history (
        order_history_id,
        order_number,
        order_status,
        origin_price,
        used_point,
        donation_price,
        final_pay_price,
        eco_deal_qr_url,
        member_id,
        department_store_id,
        created_at,
        updated_at
        ) VALUES (
        #{orderHistoryId},
        #{orderNumber},
        #{orderStatus, javaType=org.phoenix.planet.constant.OrderStatus,
        typeHandler=org.apache.ibatis.type.EnumTypeHandler},
        #{originPrice},
        #{usedPoint},
        #{donationPrice},
        #{finalPayPrice},
        #{ecoDealQrUrl, jdbcType=VARCHAR},
        #{memberId},
        #{departmentStoreId, jdbcType=VARCHAR},
        #{createdAt},
        #{updatedAt}
        )
    </insert>
    
    <!-- ID로 주문 조회 -->
    <select id="findById" parameterType="Long"
        resultType="org.phoenix.planet.dto.order.raw.OrderHistory">
        SELECT
        order_history_id as orderHistoryId,
        order_number as orderNumber,
        order_status as orderStatus,
        origin_price as originPrice,
        used_point as usedPoint,
        donation_price as donationPrice,
        final_pay_price as finalPayPrice,
        eco_deal_qr_url as ecoDealQrUrl,
        member_id as memberId,
        department_store_id as departmentStoreId,
        created_at as createdAt,
        updated_at as updatedAt
        FROM order_history
        WHERE order_history_id = #{orderHistoryId}
    </select>
    
    <!-- 주문번호로 조회 -->
    <select id="findByOrderNumber" parameterType="String"
        resultType="org.phoenix.planet.dto.order.raw.OrderHistory">
        SELECT
        order_history_id as orderHistoryId,
        order_number as orderNumber,
        order_status as orderStatus,
        origin_price as originPrice,
        used_point as usedPoint,
        donation_price as donationPrice,
        final_pay_price as finalPayPrice,
        eco_deal_qr_url as ecoDealQrUrl,
        member_id as memberId,
        department_store_id as departmentStoreId,
        created_at as createdAt,
        updated_at as updatedAt
        FROM order_history
        WHERE order_number = #{orderNumber}
    </select>
    
    <!-- 주문 번호로 주문 ID 조회 -->
    <select id="findOrderNumberById" parameterType="Long" resultType="String">
        SELECT order_number
        FROM order_history
        WHERE order_history_id = #{orderHistoryId}
    </select>
    
    <!-- QR 코드 URL 업데이트 -->
    <update id="updateQRCodeUrl">
        UPDATE order_history
        SET eco_deal_qr_url = #{ecoDealQrUrl},
        updated_at = CURRENT_TIMESTAMP
        WHERE order_history_id = #{orderHistoryId}
    </update>
    
    <!-- 기부금 금액 업데이트 -->
    <update id="updateDonationPrice" parameterType="map">
        UPDATE order_history
        SET donation_price = #{donationPrice},
        updated_at = SYSDATE
        WHERE order_history_id = #{orderHistoryId}
    </update>
    
    <!-- 주문 상태 업데이트 -->
    <update id="updateOrderStatus" parameterType="map">
        UPDATE order_history
        SET order_status =
        #{orderStatus,
        javaType=org.phoenix.planet.constant.OrderStatus,
        typeHandler=org.apache.ibatis.type.EnumTypeHandler},
        updated_at = #{updatedAt}
        WHERE order_history_id = #{orderHistoryId}
    </update>

</mapper>