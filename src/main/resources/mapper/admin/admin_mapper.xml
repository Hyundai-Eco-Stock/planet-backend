<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.phoenix.planet.mapper.AdminMapper">
    
    <!-- 에코스톡 발급 비율 -->
    <select id="selectEcoStockIssuePercentageData"
        resultType="org.phoenix.planet.dto.admin.eco_stock.IssueItem">
        SELECT
        e.name AS name,
        COUNT(si.stock_issue_id) AS count,
        ROUND(COUNT(si.stock_issue_id) * 100.0 / SUM(COUNT(si.stock_issue_id)) OVER(), 1) AS value,
        '#3B82F6' AS color -- TODO: 프론트에서 색상 매핑 가능
        FROM stock_issue si
        JOIN eco_stock e ON si.eco_stock_id = e.eco_stock_id
        WHERE si.status = 'ISSUED'
        GROUP BY e.name
        ORDER BY count DESC
    </select>
    
    <!-- 사용자별 에코스톡 보유 현황 -->
    <select id="selectEcoStockHoldingAmountDataGroupByMember"
        resultType="org.phoenix.planet.dto.admin.eco_stock.HoldingItem">
        SELECT range, COUNT(*) AS userCount,
        ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 1) AS percentage
        FROM (
        SELECT
        CASE
        WHEN msi.current_total_quantity BETWEEN 1 AND 10 THEN '1-10개'
        WHEN msi.current_total_quantity BETWEEN 11 AND 50 THEN '11-50개'
        WHEN msi.current_total_quantity BETWEEN 51 AND 150 THEN '51-150개'
        WHEN msi.current_total_quantity BETWEEN 151 AND 500 THEN '151-500개'
        WHEN msi.current_total_quantity BETWEEN 501 AND 1000 THEN '501-1000개'
        ELSE '1000개 이상'
        END AS range
        FROM member_stock_info msi
        )
        GROUP BY range
        ORDER BY range
    </select>
    
    <!-- 일별 주문/매출 -->
    <select id="selectProductOrderDataGroupByDay"
        resultType="org.phoenix.planet.dto.admin.order_product.DayItem">
        SELECT
        TO_CHAR(o.created_at, 'YYYY-MM-DD') AS order_date,
        COUNT(o.order_history_id) AS orders,
        SUM(o.final_pay_price) AS revenue
        FROM order_history o
        WHERE o.order_status IN ('PAID','SHIPPED','COMPLETED')
        GROUP BY TO_CHAR(o.created_at, 'YYYY-MM-DD')
        ORDER BY order_date
    </select>
    
    <!-- 카테고리별 판매 비율 -->
    <select id="selectProductOrderDataGroupByCategory"
        resultType="org.phoenix.planet.dto.admin.order_product.CategoryItem">
        SELECT
        pc.name AS category,
        SUM(op.price * op.quantity) AS value,
        '#3B82F6' AS color
        FROM order_product op
        JOIN product p ON op.product_id = p.product_id
        JOIN product_category pc ON p.category_id = pc.category_id
        GROUP BY pc.name
        ORDER BY value DESC
    </select>
    
    <!-- PHTI 사용자 분포 -->
    <select id="selectMemberPercentageByPhti"
        resultType="org.phoenix.planet.dto.admin.phti.MemberPercentageByPhtiItem">
        SELECT
        primary_phti AS type,
        COUNT(member_id) AS users
        FROM member_phti
        GROUP BY primary_phti
        ORDER BY users DESC
    </select>
    
    <!-- PHTI 주문/교환 패턴 -->
    <select id="selectIssueAndOrderPatternsByPhti"
        resultType="org.phoenix.planet.dto.admin.phti.IssueAndOrderPatternsByPhtiItem">
        SELECT
        mp.primary_phti AS type,
        COUNT(DISTINCT oh.order_history_id) AS orders,
        COUNT(DISTINCT si.stock_issue_id) AS exchanges
        FROM member_phti mp
        LEFT JOIN order_history oh ON mp.member_id = oh.member_id
        LEFT JOIN stock_issue si ON mp.member_id = si.member_id
        GROUP BY mp.primary_phti
        ORDER BY type
    </select>
    
    <!-- 날짜별 기부 금액 추이 -->
    <select id="selectDonationAmountsByDay"
        resultType="org.phoenix.planet.dto.admin.donation.DonationAmountsByDayItem">
        SELECT
        TO_CHAR(created_at, 'YYYY-MM-DD') AS order_date,
        SUM(donation_price) AS donation
        FROM order_history
        WHERE donation_price IS NOT NULL
        GROUP BY TO_CHAR(created_at, 'YYYY-MM-DD')
        ORDER BY order_date
    </select>
    
    <!-- 사용자별 기부 참여율 -->
    <select id="selectDonatorPercentage"
        resultType="org.phoenix.planet.dto.admin.donation.DonatorPercentageItem">
        SELECT '참여' AS name,
        COUNT(DISTINCT member_id) AS users,
        '#10B981' AS color
        FROM order_history
        WHERE donation_price > 0
        
        UNION ALL
        
        SELECT '미참여' AS name,
        (SELECT COUNT(*) FROM member) -
        (SELECT COUNT(DISTINCT member_id) FROM order_history WHERE donation_price > 0) AS users,
        '#EF4444' AS color
        FROM dual
    </select>
</mapper>